<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
	<script type="text/javascript" src="phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.CANVAS, '', { preload: preload, create: create, update: update });

function preload()
{
	game.load.image("character-parts", "res/ld35-chars.png");
	game.load.image("ui-parts", "res/ld35-ui.png");
}

var entities = [];
var playerDest = [100,100];
var cursor;
var selectedEntity = -1;
var guests;
var player;

function create()
{
	guests = game.add.group();
	cursor = game.add.sprite(0, 0, "ui-parts");
	cursor.crop(new Phaser.Rectangle(0, 0, 20, 20));

	for(var i = 0; i < 10; i++)
	{
		entities.push(createRandomCharacter(100 + i * 50, 100 + i * 50));
	}

	for(var b = 0; b < 10; b++)
	{
		entities.push(createBox(getRand(100, 200), getRand(100, 200)));
	}

	player = createRandomCharacter(100, 600);
	game.physics.startSystem(Phaser.Physics.ARCADE);
	game.input.mouse.capture = true;
}

function update()
{
	if (game.input.mousePointer.isDown)
	{
		playerDest[0] = Math.floor(game.input.mousePointer.x);
		playerDest[1] = Math.floor(game.input.mousePointer.y);

		cursor.x = playerDest[0] - 10;
		cursor.y = playerDest[1] - 10;

		if(selectedEntity >= 0)
		{
			playerDest[0] = Math.floor(entities[selectedEntity].xpos + 10);
			playerDest[1] = Math.floor(entities[selectedEntity].ypos + 20);

			cursor.x = playerDest[0] - 10;
			cursor.y = playerDest[1] - 10;
		}
	}

	var dist = getDist(playerDest[0], playerDest[1], player.xpos, player.ypos);
	var speed = 5;

    if(dist <= speed)
    {
    	player.spr[0].x = playerDest[0] - 10;
        player.spr[0].y = playerDest[1] - 65;

    	player.spr[1].x = playerDest[0] - 10;
        player.spr[1].y = playerDest[1] - 60;
            	
        player.spr[2].x = playerDest[0] - 10;
        player.spr[2].y = playerDest[1] - 40;
        
        player.spr[3].x = playerDest[0] - 10;
        player.spr[3].y = playerDest[1] - 20;

        player.xpos = playerDest[0];
        player.ypos = playerDest[1];
    }
    else
    {
        var xDist = player.xpos - playerDest[0];
        var yDist = player.ypos - playerDest[1];

        var xMove = Math.round(speed * xDist / dist);
        var yMove = Math.round(speed * yDist / dist);

        for(var i = 0; i < 4; i++)
        {
        	player.spr[i].x -= xMove;
        	player.spr[i].y -= yMove;
        }

        player.xpos -= xMove;
        player.ypos -= yMove;
    }

   	selectedEntity = -1;

    for(var s = 0; s < entities.length; s++)
    {
    	for(var k = 0; k < entities[s].spr.length; k++)
    	{
	    	if(entities[s].spr[k].input.pointerOver())
	    	{
	    		selectedEntity = s;
	    		//do mouseover event on character
	    	}
    	}
    }
}

function render()
{

}

function createRandomCharacter(x, y)
{
	var hair = getRand(0,4);
	var face = getRand(0,4);
	var shirt = getRand(0,4);
	var pants = getRand(0,4);

	while(inEntitiesList([hair,face,shirt,pants]))
	{
		hair = getRand(0,4);
		face = getRand(0,4);
		shirt = getRand(0,4);
		pants = getRand(0,4);
	}
	return createCharacter([hair, face, shirt, pants], x, y);
}

function createCharacter(parts, x, y)
{
	var newChar = [];
	
	var face = game.add.sprite(x - 10, y - 60, "character-parts");
	face.crop(new Phaser.Rectangle(20 * parts[1], 20, 20, 20));
	face.inputEnabled = true;
	
	var shirt = game.add.sprite(x - 10, y - 40, "character-parts");
	shirt.crop(new Phaser.Rectangle(20 * parts[2], 40, 20, 20));
	shirt.inputEnabled = true;

	var pants = game.add.sprite(x - 10, y - 20, "character-parts");
	pants.crop(new Phaser.Rectangle(20 * parts[3], 60, 20, 20));
	pants.inputEnabled = true;

	var hair = game.add.sprite(x - 10, y - 65, "character-parts");
	hair.crop(new Phaser.Rectangle(20 * parts[0], 0, 20, 20));
	hair.inputEnabled = true;

	newChar = {spr: [hair, face, shirt, pants], xpos: x, ypos: y};
	return newChar;
}

function createBox(x, y)
{
	var box = game.add.sprite(x, y, "ui-parts");
	box.crop(new Phaser.Rectangle(20, 0, 20, 20));
	box.inputEnabled = true;
	var newBox = {spr: [box], xpos: x, ypos: y};
	return newBox;
}

function inEntitiesList(ent)
{
	for(var i = 0; i < entities.length; i++)
	{
		if(entities[i].spr == ent) return true;
	}
	return false;
}

function getDist(x1, y1, x2, y2)
{
    var xd = x1 - x2;
    var yd = y1 - y2;
    return Math.sqrt(xd * xd + yd * yd);
}

function getRand(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

</script>

</body>
</html>